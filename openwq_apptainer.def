Bootstrap: docker
From: ubuntu:24.04

%post
  apt-get update
  apt-get -y install locales
  locale-gen en_CA.UTF-8
  apt-get upgrade -y
  DEBIAN_FRONTEND="noninteractive" \
  apt-get -y install g++ \
  gdb \
  git \
  gdbserver \
  cmake \
  wget \
  xz-utils \
  liblapack-dev \
  libblas-dev \
  libopenblas-dev \
  libboost-all-dev \
  hdf5-tools \
  software-properties-common \
  libnetcdf-dev \
  libnetcdff-dev \
  liblapack-dev \
  gfortran

  # Install PHREEQC-RM
  cd /opt
  git clone https://github.com/usgs-coupled/phreeqcrm_use_cmake.git phreeqcrm -b modern
  cd phreeqcrm
  git checkout cf03df1
  cmake . -P build_phreeqcrm.cmake -DCMAKE_INSTALL_PREFIX=/usr/local/phreeqcrm
  
  # Install Sundials
  cd /opt
  wget https://github.com/LLNL/sundials/archive/refs/tags/v7.1.1.tar.gz
  tar -xzf v7.1.1.tar.gz
  cd sundials-7.1.1/
  mkdir build
  cd build
  cmake ../ -DBUILD_FORTRAN_MODULE_INTERFACE=ON \
    -DCMAKE_Fortran_COMPILER=gfortran \
    -DCMAKE_INSTALL_PREFIX=/usr/local/sundials
  make -j4
  make install

  # Install Armadillo
  cd /opt
  wget http://sourceforge.net/projects/arma/files/armadillo-10.6.0.tar.xz
  tar -xf armadillo-10.6.0.tar.xz
  cd /opt/armadillo-10.6.0
  cmake . -D DETECT_HDF5=true -DCMAKE_C_FLAGS="-DH5_USE_110_API"
  make install
  sed -i '121s/^\/\/ #define ARMA_USE_HDF5/#define ARMA_USE_HDF5/' /usr/include/armadillo_bits/config.hpp
  
  # Install piolib (ParallelIO) (needed for MizuRoute_lakes)
  cd /opt
  git clone https://github.com/NCAR/ParallelIO.git
  cd /opt/ParallelIO
  git checkout 39e5584
  git clone https://github.com/PARALLELIO/genf90.git bin
  cd /opt/ParallelIO/bin
  git checkout 51cf293
  git clone https://github.com/CESM-Development/CMake_Fortran_utils.git cmake
  cd /opt/ParallelIO/bin/cmake
  git checkout 05ff8d8
  cd /opt
  mkdir pio-build
  mkdir piolib
  cd pio-build
  cmake ../ParallelIO \
    -DPIO_ENABLE_FORTRAN=ON \
    -DPIO_ENABLE_TIMING=ON \
    -DNetCDF_C_INCLUDE_DIR=$(nc-config --includedir) \
    -DNetCDF_C_LIBRARY=$(nc-config --libdir)/libnetcdf.so \
    -DPnetCDF_C_INCLUDE_DIR=$(pnetcdf-config --includedir) \
    -DPnetCDF_C_LIBRARY=$(pnetcdf-config --libdir)/libpnetcdf.so \
    -DCMAKE_C_COMPILER=mpicc \
    -DCMAKE_Fortran_COMPILER=mpifort \
    -DCMAKE_CXX_COMPILER=mpicxx \
    -DCMAKE_INSTALL_PREFIX=../piolib
  make -j4
  make install